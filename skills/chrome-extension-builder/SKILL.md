---
name: chrome-extension-builder
description: Build production-ready Chrome extensions with Manifest V3, React, TypeScript, Vite, and Zillow's Constellation design system. Covers complete architecture (service workers, content scripts, popup, side panel, options, DevTools), all major Chrome APIs, Shadow DOM style isolation, Constellation font/token/component integration, testing, Chrome Web Store publishing, and cross-browser compatibility.
license: MIT
compatibility: Chrome 114+, Manifest V3, React 18+, TypeScript, Vite
metadata:
  author: Zillow Group
  version: "1.0.0"
---

# Chrome Extension Builder

Build Chrome extensions using Manifest V3 with React, TypeScript, Vite, and Zillow's Constellation design system.

## Reference Documentation

### Core

- [Manifest V3](reference/manifest-v3.md): Complete manifest.json reference — fields, permissions, host permissions, CSP, icons, web accessible resources, and content scripts configuration.
- [Architecture](reference/architecture.md): Extension component architecture — service workers, content scripts, popup, side panel, options page, DevTools panels, message passing, and lifecycle management.
- [Chrome APIs](reference/chrome-apis.md): Complete API reference — storage, tabs, scripting, action (badges/icons), contextMenus, alarms, notifications, runtime, and messaging patterns.

### Integration

- [Constellation Integration](reference/constellation-integration.md): Integrating Zillow's Constellation design system into Chrome extensions — bundling Inter/Object Sans fonts locally, injecting CSS design tokens, using PandaCSS with Shadow DOM, and rendering Constellation React components in extension UIs.
- [React + Vite Build](reference/react-vite-build.md): Build configuration for React + TypeScript + Vite extensions — multi-entry builds (popup, content, background, side panel), CRXJS plugin, path aliases, asset handling, and development workflow.

### Advanced Patterns

- [Remote Rendering & Auto-Updates](reference/remote-updates.md): Serving extension UI from remote servers, real-time data push via WebSocket/SSE, iframe embedding, polling with cache, remote config/feature flags, and hybrid local+remote patterns.

### Quality & Distribution

- [Testing & Publishing](reference/testing-publishing.md): Unit testing with Jest/Vitest, E2E testing with Puppeteer, Chrome Web Store publishing requirements, privacy policy, and store listing optimization.
- [Cross-Browser](reference/cross-browser.md): Firefox, Edge, and Safari compatibility — API namespace differences, webextension-polyfill, manifest variations, and build strategies.

---

## Quick Start: Zillow-Branded Extension

### 1. Project Structure

```
my-extension/
├── manifest.json
├── panda.config.ts
├── vite.config.ts
├── tsconfig.json
├── package.json
├── src/
│   ├── popup/
│   │   ├── index.html
│   │   ├── main.tsx
│   │   └── App.tsx
│   ├── content/
│   │   ├── index.tsx
│   │   └── App.tsx
│   ├── background/
│   │   └── service-worker.ts
│   ├── sidepanel/
│   │   ├── index.html
│   │   ├── main.tsx
│   │   └── App.tsx
│   ├── options/
│   │   ├── index.html
│   │   ├── main.tsx
│   │   └── App.tsx
│   ├── components/
│   │   └── ... (shared React components)
│   ├── utils/
│   │   ├── create-shadow-root.tsx
│   │   └── inject-constellation.ts
│   └── styles/
│       ├── constellation-tokens.css
│       └── fonts.css
├── fonts/
│   ├── inter-variable.woff2
│   └── object-sans-heavy.woff2
├── icons/
│   ├── icon16.png
│   ├── icon48.png
│   └── icon128.png
└── styled-system/           (generated by PandaCSS)
```

### 2. Minimal manifest.json

```json
{
  "manifest_version": 3,
  "name": "My Zillow Extension",
  "version": "1.0.0",
  "description": "A Zillow-branded Chrome extension",
  "action": {
    "default_popup": "popup/index.html",
    "default_icon": {
      "16": "icons/icon16.png",
      "48": "icons/icon48.png",
      "128": "icons/icon128.png"
    }
  },
  "background": {
    "service_worker": "service-worker.js",
    "type": "module"
  },
  "permissions": ["storage", "activeTab"],
  "content_security_policy": {
    "extension_pages": "script-src 'self'; object-src 'self'; font-src 'self';"
  },
  "web_accessible_resources": [{
    "resources": ["fonts/*", "styles/*"],
    "matches": ["<all_urls>"]
  }],
  "icons": {
    "16": "icons/icon16.png",
    "48": "icons/icon48.png",
    "128": "icons/icon128.png"
  }
}
```

### 3. Key Decisions

| Decision | Recommendation |
|----------|---------------|
| **Build tool** | Vite with `@crxjs/vite-plugin` for HMR, or manual multi-entry Rollup config |
| **Framework** | React 18+ with TypeScript |
| **Styling** | PandaCSS with Constellation preset for popup/options/sidepanel; CSS variables for content scripts |
| **Content script isolation** | Shadow DOM with locally bundled fonts and injected token CSS |
| **State persistence** | `chrome.storage.local` (not global variables — service workers terminate) |
| **Async pattern** | Use async/await (Chrome 121+) or callbacks (Chrome 114-120) |

---

## Critical Rules

### Manifest V3 Requirements
1. **No remote code** — all JS/CSS must be bundled with the extension
2. **Service workers** replace persistent background pages — they terminate when idle
3. **No `eval()` or `new Function()`** — CSP prohibits dynamic code evaluation
4. **Permissions are granular** — request only what you need; `host_permissions` are separate
5. **`chrome.declarativeNetRequest`** replaces blocking `chrome.webRequest`
6. **Manifest paths must reference built JS** — use `"service-worker.js"` not `"src/background/service-worker.ts"` (source paths are for your build tool, not the manifest)
7. **Promise-based Chrome APIs** require Chrome 121+ — for Chrome 114-120 support, use callbacks or `webextension-polyfill`

### Service Worker Gotchas
1. **No DOM access** — cannot use `document`, `window`, or DOM APIs
2. **No persistent state** — global variables reset on termination; use `chrome.storage`
3. **Return `true`** from `onMessage` listeners when using async `sendResponse()`
4. **~30 second idle timeout** — Chrome APIs reset the timer
5. **Use `chrome.alarms`** instead of `setTimeout`/`setInterval` for reliable scheduling

### Constellation in Extensions
1. **Bundle fonts locally** — CDN URLs violate CSP; download `.woff2` files and include in extension
2. **Bundle design tokens locally** — copy `constellation-tokens.css` into extension's `styles/` directory; do NOT import from `node_modules` at runtime
3. **Use `chrome.runtime.getURL()`** for all extension resource paths at runtime (in JS); use `chrome-extension://__MSG_@@extension_id__/` only in static CSS files
4. **Shadow DOM required** for content scripts — isolates Constellation styles from host pages
5. **Import tokens CSS as string** — inject into Shadow DOM via `<style>` or `adoptedStyleSheets`
6. **PandaCSS works in popup/options/sidepanel** — these are full extension pages; PandaCSS output is bundled at build time
7. **Content scripts need pre-built CSS** — PandaCSS output must be inlined, not dynamically generated

### Common Mistakes
| Mistake | Fix |
|---------|-----|
| Inline scripts in HTML | Move all JS to separate files, reference with `<script src="...">` |
| `localStorage` in service worker | Use `chrome.storage.local` instead |
| Forgetting `return true` in async message handlers | Always return `true` when using async `sendResponse()` |
| Hash-based filenames in build output | Configure Vite/Rollup with fixed output names |
| Absolute paths (`/assets/...`) | Set `base: './'` in Vite config for relative paths |
| Loading Google Fonts from CDN in content scripts | Bundle `.woff2` files locally and declare in `web_accessible_resources` |
| Global CSS in content scripts leaking to host page | Use Shadow DOM with `attachShadow({ mode: 'open' })` |

---

## Extension Types & When to Use Each UI Surface

| UI Surface | Best For | Lifecycle | Chrome APIs |
|------------|----------|-----------|-------------|
| **Popup** | Quick actions, status display, settings toggle | Closes when clicking outside | Full access |
| **Side Panel** | Persistent companion UI alongside web pages | Stays open across navigation | Full access |
| **Options Page** | Extension settings and configuration | Tab or embedded in chrome://extensions | Full access |
| **Content Script** | DOM manipulation, injecting UI into web pages | Per-page lifecycle | Limited (storage, runtime messaging) |
| **Service Worker** | Event handling, API calls, coordination | Event-driven, terminates when idle | Full access, no DOM |
| **DevTools Panel** | Developer inspection tools | While DevTools is open | DevTools APIs + limited Chrome APIs |

---

## Communication Architecture

```
┌─────────────┐      ┌──────────────────┐      ┌─────────────────┐
│   Popup     │◄────►│ Service Worker   │◄────►│ Content Script  │
│  (popup.js) │      │(service-worker.ts)│      │   (content.ts)  │
└─────────────┘      └──────────────────┘      └─────────────────┘
       ▲                      ▲                          │
       │                      │                          │
  Full Chrome APIs     Full Chrome APIs           DOM Access
  No DOM Access        No DOM Access              Limited APIs
       │                      ▲
       │               ┌──────┴──────┐
       └──────────────►│  Side Panel  │
                       │(sidepanel.ts)│
                       └─────────────┘

Message Passing:
  • Popup/SidePanel → Service Worker:  chrome.runtime.sendMessage()
  • Service Worker → Content Script:   chrome.tabs.sendMessage(tabId, ...)
  • Content Script → Service Worker:   chrome.runtime.sendMessage()
  • Any → Storage:                     chrome.storage.local.set/get()
```

---

## Zillow Design System Integration Summary

### Extension Pages (Popup, Side Panel, Options)
These are full HTML pages owned by the extension — use Constellation normally:

```tsx
import { Button, Card, Text, Icon } from '@zillow/constellation';
import { IconSearchFilled } from '@zillow/constellation-icons';
import { css } from '../styled-system/css';
import { Box, Flex } from '../styled-system/jsx';

function PopupApp() {
  return (
    <Flex direction="column" gap="300" css={{ p: '400', width: '360px' }}>
      <Text textStyle="body-lg-bold">My Extension</Text>
      <Button tone="brand" emphasis="filled" size="md">
        Search
      </Button>
    </Flex>
  );
}
```

### Content Scripts (Injected into Host Pages)
Content scripts inject UI into pages you don't control — use Shadow DOM + locally bundled assets:

```tsx
import { createRoot } from 'react-dom/client';

const container = document.createElement('div');
container.id = 'zillow-ext-root';
document.body.appendChild(container);

const shadow = container.attachShadow({ mode: 'open' });

const fontCSS = await fetch(chrome.runtime.getURL('styles/fonts.css')).then(r => r.text());
const tokenCSS = await fetch(chrome.runtime.getURL('styles/constellation-tokens.css')).then(r => r.text());

const sheet = new CSSStyleSheet();
sheet.replaceSync(fontCSS + '\n' + tokenCSS);
shadow.adoptedStyleSheets = [sheet];

const mountPoint = document.createElement('div');
shadow.appendChild(mountPoint);
createRoot(mountPoint).render(<ContentApp />);
```

### Font Bundling
Download and bundle fonts locally to avoid CSP violations:

```css
/* styles/fonts.css */
@font-face {
  font-family: "Inter";
  font-display: swap;
  font-stretch: 100%;
  font-weight: 400 800;
  src: url("chrome-extension://__MSG_@@extension_id__/fonts/inter-variable.woff2") format("woff2");
}
@font-face {
  font-family: "Object Sans";
  font-display: swap;
  font-weight: 800;
  src: url("chrome-extension://__MSG_@@extension_id__/fonts/object-sans-heavy.woff2") format("woff2");
}
```

See [Constellation Integration](reference/constellation-integration.md) for the complete guide.

---

## Remote Rendering & Auto-Updates

Extensions can serve UI from remote servers or receive real-time data pushes without Chrome Web Store republishing:

| Pattern | When to Use |
|---------|-------------|
| **Side Panel remote URL** | Your extension is a companion to a web app — load the web app directly in the side panel |
| **Iframe embedding** | Embed auto-updating remote content inside a local popup/options page that retains Chrome API access |
| **WebSocket/SSE push** | Real-time data updates to locally-rendered UI (dashboards, notifications, live feeds) |
| **Polling with cache** | Periodic data refresh with offline fallback — simplest reliable pattern |
| **Remote config** | Feature flags and settings from server without republishing |
| **Hybrid** | Local Constellation shell + remote data/content blocks (recommended for production) |

Key constraints:
- Remote pages have NO Chrome API access — must relay via `postMessage` or `chrome.runtime.sendMessage()`
- Extension popup/options CSP blocks remote `<script>` tags — only iframes or fetched data work
- Service worker WebSocket connections close on idle — use `chrome.alarms` for keep-alive
- Always cache server data in `chrome.storage` for offline resilience

See [Remote Rendering & Auto-Updates](reference/remote-updates.md) for complete patterns and code examples.
